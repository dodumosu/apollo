<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('pwa.static', filename='vendor/animate.css/animate.min.css') }}">
  {% if g.locale.text_direction == 'rtl' %}
  <link rel="stylesheet" href="{{ url_for('pwa.static', filename='vendor/bootstrap/css/bootstrap.rtl.min.css') }}">
  {% else %}
  <link rel="stylesheet" href="{{ url_for('pwa.static', filename='vendor/bootstrap/css/bootstrap.min.css') }}">
  {% endif %}
  <link rel="stylesheet" href="{{ url_for('pwa.static', filename='vendor/notiflix/notiflix-2.7.0.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('pwa.static', filename='css/main.css') }}">
  <link rel="manifest" href="{{ url_for('pwa.static', filename='manifest.json') }}">
  <title>{{ page_title }}</title>
</head>
<body class="h-100">
  <div id="app">
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top mb-6">
      <div class="container-fluid">
        <a class="navbar-brand">{{ page_title }}</a>
        <connectivity-indicator></connectivity-indicator>
      </div>
    </nav>
    <main class="container h-100">
      <div class="row h-75 align-items-center">
        <div class="col-md-6 offset-md-3">
          <transition mode="out-in" enter-active-class="animate__animated animate__fadeIn" leave-active-class="animate__animated animate__fadeOut">
            <login-form v-if="participant === null" @authenticated="authenticationSuccess" :navigator-online="navigatorOnline"></login-form>
            <div v-else>
              <div class="mb-3">
                <welcome :participant="participant" @logged-out="loggedOut(true)"></welcome>
              </div>
              <div class="mb-3">
                <transition mode="out-in" enter-active-class="animate__animated animate__fadeIn" leave-active-class="animate__animated animate__fadeOut">
                  <form-list v-if="currentForm === null && currentSubmission === null" :forms="forms" :navigator-online="navigatorOnline" @load-forms="refreshForms" @unauthorized="loggedOut(false)" @edit-submission="editSubmission" @show-submission-list="showSubmissionList"></form-list>
                  <submission-editor v-else-if="currentForm !== null && currentSubmission !== null" :form="currentForm" :navigator-online="navigatorOnline" :submission="currentSubmission" @save-submission="saveSubmissionToDatabase" @post-submission="postSubmission" @clear-form="clearCurrentForm"></submission-editor>
                  <submission-list v-else-if="currentForm !== null && currentForm.form_type !== 'CHECKLIST' && currentSubmission === null" :form="currentForm" :incidents="incidents[currentForm.id]" :surveys="surveys[currentForm.id]" @edit-submission="editSubmission" @clear-form="clearCurrentForm"></submission-list>
                </transition>
              </div>
            </div>
          </transition>
        </div>
      </div>
    </main>
  </div>
  <template id="connectivity-indicator">
    <div class="d-flex text-light">
      <svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg" v-if="isOnline"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.636 5.636a1 1 0 00-1.414-1.414c-4.296 4.296-4.296 11.26 0 15.556a1 1 0 001.414-1.414 9 9 0 010-12.728zm14.142-1.414a1 1 0 10-1.414 1.414 9 9 0 010 12.728 1 1 0 101.414 1.414c4.296-4.296 4.296-11.26 0-15.556zM8.464 8.464A1 1 0 007.05 7.05a7 7 0 000 9.9 1 1 0 101.414-1.414 5 5 0 010-7.072zM16.95 7.05a1 1 0 10-1.414 1.414 5 5 0 010 7.072 1 1 0 001.414 1.414 7 7 0 000-9.9zM9 12a3 3 0 116 0 3 3 0 01-6 0z" fill="currentColor"/></svg>
      <svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg" v-else><path fill-rule="evenodd" clip-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414L15.535 16.95l2.829 2.828 1.929 1.93a1 1 0 001.414-1.415l-1.253-1.254c3.607-4.321 3.382-10.76-.676-14.817a1 1 0 10-1.414 1.414 9.001 9.001 0 01.668 11.982l-1.425-1.425a7.002 7.002 0 00-.657-9.143 1 1 0 10-1.414 1.414 5.002 5.002 0 01.636 6.294l-1.465-1.465a3 3 0 00-4-4l-7-7zM3.75 8.4a1 1 0 00-1.834-.8C.161 11.624.928 16.485 4.222 19.778a1 1 0 001.414-1.414A9.004 9.004 0 013.749 8.4zm3.32 2.766a1 1 0 00-1.972-.332A6.992 6.992 0 007.05 16.95a1 1 0 101.414-1.414 4.993 4.993 0 01-1.394-4.37z" fill="currentColor"/></svg>
    </div>
  </template>
  <template id="login-form">
    <div class="form-signin">
      <form>
        <div class="card">
          <h5 class="card-header">{{ _('Login') }}</h5>
          <div class="card-body">
            <div class="mb-3">
              <label for="participant_id" class="visually-hidden">{{ _('Participant ID') }}</label>
              <input type="text" class="form-control bg-light" id="participant_id" placeholder="{{ _('Participant ID') }}" v-model="participant_id">
            </div>
            <div class="mb-3">
              <label for="password" class="visually-hidden">{{ _('Password') }}</label>
              <input type="password" class="form-control bg-light" id="password" placeholder="{{ _('Password') }}" v-model="password">
            </div>
            <div class="mb-3">
              <div class="d-grid gap-2">
                <button class="btn btn-primary" @click="authenticate($event)" :disabled="!navigatorOnline">{{ _('Login') }}</button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </template>
  <template id="welcome">
    <div class="row">
      <div class="col">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">[[ greeting() ]], [[ participant.full_name ]]</h5>
            <p>{{ _('If this is not you, please') }} <a @click="logout" class="btn btn-outline-dark">{{ _('click here') }}</a></p>
          </div>
        </div>
      </div>
    </div>
  </template>
  <template id="form-list">
    <div class="card">
      <h5 class="card-header">{{ _('Forms') }}</h5>
      <div class="list-group list-group-flush">
        <div class="list-group-item" v-for="form in forms" :key="form.id">[[ form.name ]] <button class="btn btn-outline-dark float-end" @click="formAction(form)">[[ actionLabel(form) ]]</button></div>
      </div>
      <div class="card-footer">
        <button class="btn btn-outline-dark" @click="refreshForms" :disabled="!navigatorOnline">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16">
            <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
            <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
          </svg>
          {{ _('Load forms') }}
        </button>
      </div>
    </div>
  </template>
  <template id="submission-list">
    <div class="card">
      <h5 class="card-header">[[ form.name ]]</h5>
      <div class="list-group list-group-flush">
        <div class="list-group-item" v-for="(submission, index) in submissions">
          [[ index + 1 ]] <button class="btn btn-outline-dark float-end" @click="editSubmission(submission)">{{ _('Edit') }}</button>
        </div>
      </div>
      <div class="card-footer">
        <button class="btn btn-outline-dark" @click="newSubmission">{{ _('Add new') }}</button>
        <button class="btn btn-outline-dark" @click="clearForm">{{ _('Back') }}</button>
      </div>
    </div>
  </template>
  <template id="submission-editor">
    <div class="card">
      <h5 class="card-header">[[ form.name ]]</h5>
      <div class="card-body">
        <form>
          <fieldset v-if="form.form_type === 'SURVEY'">
            <div class="mb-3">
              <label for="serial" class="form-label">{{ _('Serial number') }}</label>
              <input class="form-control" name="serial" id="serial" v-model="submission.serial">
            </div>
          </fieldset>
          <fieldset v-for="group in form.data.groups">
            <legend>[[ group.name ]]</legend>
            <div v-for="field in group.fields">
              <div class="mb-3" v-if="field.type === 'integer'">
                <label :for="field.tag" class="form-label"><span class="fw-bold">[[ field.tag ]]</span> [[ field.description ]]</label>
                <input type="number" :name="field.tag" :id="field.tag" class="form-control" v-model.number="submission.data[field.tag]" :max="field.max" :min="field.min">
              </div>
              <div class="mb-3" v-else-if="field.type === 'select'">
                <label :for="field.tag" class="form-label"><span class="fw-bold">[[ field.tag ]]</span> [[ field.description ]]</label>
                <div class="form-check" v-for="(value, label) in field.options">
                  <label :for="field.tag" class="form-label">[[ label ]]</label>
                  <input type="radio" :name="field.tag" :id="field.tag + '_' + value" class="form-check-input" :value="value" v-model="submission.data[field.tag]">
                </div>
              </div>
              <div class="mb-3" v-else-if="field.type === 'multiselect'">
                <label :for="field.tag" class="form-label"><span class="fw-bold">[[ field.tag ]]</span> [[ field.description ]]</label>
                <div class="form-check" v-for="(value, label) in field.options">
                  <label :for="field.tag" class="form-label">[[ label ]]</label>
                  <input type="checkbox" name="field.tag" :id="field.tag + '_' + value" class="form-check-input" :value="value" v-model="submission.data[field.tag]">
                </div>
              </div>
              <div class="mb-3" v-else-if="field.type === 'string'">
                <label :for="field.tag" class="form-label"><span class="fw-bold">[[ field.tag ]]</span> [[ field.description ]]</label>
                <input type="text" :name="field.tag" :id="field.tag" class="form-control" v-model="submission.data[field.tag]">
              </div>
              <div class="mb-3" v-else-if="field.type === 'comment'">
                <label :for="field.tag" class="form-label"><span class="fw-bold">[[ field.tag ]]</span> [[ field.description ]]</label>
                <textarea cols="30" rows="10":name="field.tag" :id="field.tag" class="form-control" v-model="submission.data[field.tag]"></textarea>
              </div>
              <image-field v-else-if="field.type === 'image'" :field="field" :initial-data="submission.images[field.tag] || null" @update-image="updateImage"></image-field>
            </div>
          </fieldset>
          <fieldset v-if="canRetrieveLocation">
            <legend>{{ _('Location') }}</legend>
            <div class="mb-3">
              <pre>([[ coordinates[1] ]], [[ coordinates[0] ]])</pre>
              <button class="btn btn-outline-dark" @click="getLocation($event)">{{ _('Get location') }}</button>
            </div>
          </fieldset>
        </form>
      </div>
      <div class="card-footer">
        <button class="btn btn-outline-dark" @click="stopEditing">{{ _('Save and go to form list') }}</button>
        <button class="btn btn-outline-dark" @click="clearForm">{{ _('Cancel and go to form list') }}</button>
        <button class="btn btn-outline-dark" @click="postSubmission" :disabled="!navigatorOnline">{{ _('Submit') }}</button>
      </div>
    </div>
  </template>
  <template id="image-field">
    <div class="mb-3">
      <div class="card"><img src="" alt="" class="card-img-top" ref="viewer" width="200"></div>
      <label :for="field.tag" class="form-label"><span class="fw-bold">[[ field.tag ]]</span> [[ field.description ]]</label>
      <input type="file" :name="field.tag" :id="field.tag" class="form-control" accept="image/*" @change="processFile($event)">
    </div>
  </template>
  <script src="{{ url_for('pwa.static', filename='vendor/bootstrap/js/bootstrap.min.js') }}"></script>
  <script src="{{ url_for('pwa.static', filename='vendor/dexie/dexie.min.js') }}"></script>
  <script src="{{ url_for('pwa.static', filename='vendor/image-blob-reduce/image-blob-reduce.min.js') }}"></script>
  <script src="{{ url_for('pwa.static', filename='vendor/notiflix/notiflix-2.7.0.min.js') }}"></script>
  <script src="{{ url_for('pwa.static', filename='vendor/vue/vue.min.js') }}"></script>
  <script src="{{ url_for('pwa.static', filename='js/app.js') }}"></script>
  <script src="{{ url_for('pwa.static', filename='js/client.js') }}"></script>
  <script>
    // API setup
    const endpoints = {
      list: "{{ url_for('forms.api_form_list') }}",
      login: "{{ url_for('participants.login') }}",
      logout: "{{ url_for('participants.logout') }}",
      logout2: "{{ url_for('participants.logout2') }}",
      refresh: "{{ url_for('participants.refresh') }}",
      submit: "{{ url_for('submissions.submission') }}",
    };
    const client = new APIClient(endpoints);

    // database setup
    const db = new Dexie('apollo');
    db.version(1).stores({
      forms: '',
      participant: '',
      checklists: '++id, form',
      incidents: '++id, form',
      surveys: '++id, form, serial',
    });
    db.open().catch(() => {
      Notiflix.Report.Failure(
        '{{ _("Error") }}',
        '{{ _("There was an error with the data storage") }}',
        '{{ _("OK") }}',
      );
    });

    // image reducer
    const imageResizer = new ImageBlobReduce({
      pica: ImageBlobReduce.pica({features: ['js', 'wasm', 'ww']})
    });
    const convertBlobToBase64 = blob => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = reject;
      reader.onload = () => {
        resolve(reader.result);
      }
      reader.readAsDataURL(blob);
    });

    // app setup
    Vue.options.delimiters = ['[[', ']]'];

    // image field component
    Vue.component('image-field', {
      data() {
        return {};
      },
      methods: {
        processFile(event) {
          let instance = this;
          let imageFile = event.target.files[0];
          imageResizer.toBlob(imageFile, {max: 200})
            .then(previewBlob => {
              convertBlobToBase64(previewBlob)
                .then(convertedBlob => {
                  instance.$refs.viewer.src = convertedBlob;
                  instance.$emit('update-image', imageFile, instance.field);
                });
              });
        },
      },
      mounted() {
        let instance = this;
        let imageFile = instance.initialData;
        if (imageFile === null || imageFile === undefined)
          return;
        imageResizer.toBlob(imageFile, {max: 200})
          .then(previewBlob => {
            convertBlobToBase64(previewBlob)
              .then(convertedBlob => {
                instance.$refs.viewer.src = convertedBlob;
              });
          });
      },
      props: ['field', 'initialData'],
      template: '#image-field'
    });

    // component for online status
    Vue.component('connectivity-indicator', {
      data() {
        return {
          isOnline: navigator.onLine
        };
      },

      methods: {
        toggleOnlineStatus() {
          this.isOnline = navigator.onLine;
        }
      },

      mounted() {
        window.addEventListener('offline', this.toggleOnlineStatus);
        window.addEventListener('online', this.toggleOnlineStatus);
      },

      template: '#connectivity-indicator'
    });

    // login component
    Vue.component('login-form', {
      data() {
        return {
          participant_id: null,
          password: null
        };
      },
      methods: {
        authenticate(event) {
          event.preventDefault();
          let instance = this;
          Notiflix.Loading.Standard('{{ _("Please wait") }}');
          client.authenticate(this.participant_id, this.password)
            .then(result => {
              Notiflix.Loading.Remove();
              if (result.status === 200) {
                result.result.then(data => {
                  let participant = data.data.participant;
                  participant.tokens = {
                    accessToken: data.data.access_token,
                    refreshToken: data.data.refresh_token
                  };
                  instance.$emit('authenticated', participant);
                });
              } else {
                Notiflix.Report.Failure(
                  '{{ _("Error") }}',
                  '{{ _("Please check your credentials and try again") }}',
                  '{{ _("OK") }}',
                );
              }
            })
            .catch(() => {
              Notiflix.Loading.Remove();
            });
        }
      },
      props: ['navigatorOnline'],
      template: '#login-form'
    });

    // welcome component
    Vue.component('welcome', {
      computed: {
      },
      data() {
        return {};
      },
      methods: {
        greeting() {
          let dt = new Date();
          if (dt.getHours() < 12)
            return '{{ _("Good morning") }}';
          else if (12 >= dt.getHours() && dt.getHours() < 17)
            return '{{ _("Good afternoon") }}';
          else
            return '{{ _("Good evening") }}';
        },
        logout() {
          this.$emit('logged-out');
        }
      },
      props: ['forms', 'participant'],
      template: '#welcome'
    });

    // form list component
    Vue.component('form-list', {
      data() {
        return {};
      },
      methods: {
        actionLabel(form) {
          if (form.form_type === 'CHECKLIST')
            return '{{ _("Edit") }}';
          else
            return '{{ _("View submissions") }}';
        },
        formAction(form) {
          if (form.form_type === 'CHECKLIST')
            this.$emit('edit-submission', form, null);
          else
            this.$emit('show-submission-list', form);
        },
        refreshForms() {
          this.$emit('load-forms');
        }
      },
      props: ['forms', 'navigatorOnline'],
      template: '#form-list'
    });

    // submission list (for incidents and surveys)
    Vue.component('submission-list', {
      computed: {
        submissions() {
          if (this.form.form_type === 'INCIDENT')
            return this.incidents;
          else
            return this.surveys;
        }
      },
      data() { return {}; },
      methods: {
        clearForm() {
          this.$emit('clear-form');
        },
        editSubmission(submission) {
          this.$emit('edit-submission', this.form, submission);
        },
        newSubmission() {
          this.$emit('edit-submission', this.form, null);
        }
      },
      props: ['form', 'incidents', 'surveys'],
      template: '#submission-list'
    });

    Vue.component('submission-editor', {
      computed: {
        coordinates() {
          if (this.location)
            return this.location
          else
            return ['{{ _("N/A") }}', '{{ _("N/A") }}']
        }
      },
      data() {
        return {
          canRetrieveLocation: 'geolocation' in navigator,
          location: null,
          images: {}
        };
      },
      methods: {
        clearForm() {
          this.$emit('clear-form');
        },
        updateImage(imageData, field) {
          let instance = this;
          instance.images[field.tag] = imageData;
        },
        updateSubmission() {
          if (this.location)
            this.submission.data.location = this.location;

          if (this.images !== {})
            this.submission.images = this.images;
        },
        stopEditing() {
          this.updateSubmission();
          this.$emit('save-submission', this.submission, true);
        },
        postSubmission() {
          this.updateSubmission();
          this.$emit('post-submission', this.submission);
        },
        getLocation(event) {
          event.preventDefault();
          let instance = this;
          navigator.geolocation.getCurrentPosition(
            position => {
              instance.location = [position.coords.longitude, position.coords.latitude];
            },
            () => Notiflix.Report.Failure(
              '{{ _("Error") }}',
              '{{ _("There was an error retreiving your location") }}',
              '{{ _("OK") }}',
            )
          );
        }
      },
      mounted() {
        this.images = this.submission.images;
        this.location = this.submission.data.location;
      },
      props: ['form', 'navigatorOnline', 'submission'],
      template: '#submission-editor',
    });

    // main app
    let vm;
    vm = new Vue({
      data: {
        checklists: null,
        currentForm: null,
        currentSubmission: null,
        forms: null,
        incidents: null,
        navigatorOnline: navigator.onLine,
        participant: null,
        surveys: null
      },
      el: '#app',
      methods: {
        clearCurrentForm() {
          this.currentForm = null;
          this.currentSubmission = null;
        },
        async refreshForms() {
          let instance = this;
          let result;
          try {
            result = await client.getForms(instance.participant.tokens.accessToken, instance.participant.events);
            if (result.status === 200) {
              result.result.then(data => {
                instance.formsLoaded(data.objects);
              });
            } else {
              instance.$emit('unauthorized');
            }
          } catch (error) {
            Notiflix.Report.Failure(
              '{{ _("Error") }}',
              '{{ _("Could not load forms. Might you be offline?") }}',
              '{{ _("OK") }}',
            );
          }
        },
        authenticationSuccess(participant) {
          this.participant = participant;
          this.saveParticipantToDatabase(participant);
          this.refreshForms();
        },
        formsLoaded(forms) {
          this.forms = forms.reduce((registry, form) => {
            registry[form.id] = form;
            return registry;
          }, {});
          this.saveFormstoDatabase(this.forms);
        },
        saveFormstoDatabase(forms) {
          db.transaction('rw', db.forms, () => {
            db.forms.put(forms, 1);
          });
        },
        clearDatabase() {
          db.transaction('rw', [db.forms, db.participant, db.checklists, db.incidents, db.surveys], () => {
            db.forms.clear();
            db.participant.clear();
            db.checklists.clear();
            db.incidents.clear();
            db.surveys.clear();
          });
        },
        loadParticipantFromDatabase() {
          let instance = this;
          db.participant.get(1)
            .then(participant => {
              if (participant)
                instance.participant = participant;
            })
            .catch(() =>
              Notiflix.Report.Failure(
                '{{ _("Error") }}',
                '{{ _("Could not load data from database") }}',
                '{{ _("OK") }}',
              )
            );
        },
        saveParticipantToDatabase(participant) {
          db.transaction('rw', db.participant, () => {
            db.participant.put(participant, 1);
          }).catch(() => Notiflix.Report.Failure(
            '{{ _("Error") }}',
            '{{ _("Could not save data to the database") }}',
            '{{ _("OK") }}',
          ));
        },
        loggedOut(clearAll) {
          client.logout(this.participant.tokens.accessToken);
          client.logout2(this.participant.tokens.refreshToken);
          this.participant = null;
          this.currentForm = null;
          this.currentSubmission = null;
          if (clearAll)
            this.clearDatabase();
        },
        newSubmission(form) {
          let instance = this;
          let submission = {
            created: new Date(),
            errorMessage: null,
            form: form.id,
            images: {},
            posted: null,
            status: 'ok',
            updated: null
          };
          submission.data = form.data.groups.reduce((acc, group) => {
            group.fields.forEach(field => {
              if (field.type === 'multiselect')
                acc[field.tag] = [];
            });
            return acc;
          }, {});

          if (form.form_type === 'CHECKLIST') {
            let checklists = instance.checklists || {};
            let checklist = {};
            checklist[form.id] = submission;
            instance.checklists = Object.assign({}, checklists, checklist);
          }
          else {
            let storage = form.form_type === 'INCIDENT' ? instance.incidents : instance.surveys;
            storage = storage || {};
            let collection = storage[form.id] || [];
            collection.push(submission);
            if (form.form_type === 'INCIDENT')
              instance.incidents = Object.assign({}, storage);
            else
              instance.surveys = Object.assign({}, storage);
          }

          return submission;
        },
        editSubmission(form, sub) {
          let submission;
          if (sub === null || sub === undefined) {
            if (form.form_type === 'CHECKLIST') {
              submission = this.checklists[form.id] || this.newSubmission(form);
            } else
              submission = this.newSubmission(form);
          } else
            submission = sub;
          this.currentForm = form;
          this.currentSubmission = submission;
        },
        saveSubmissionToDatabase(submission, reset) {
          let instance = this;
          let form = instance.forms[submission.form];
          let table;
          submission.updated = new Date();
          switch (form.form_type) {
            case 'CHECKLIST':
              table = db.checklists;
              break;
            case 'INCIDENT':
              table = db.incidents;
              break;
            case 'SURVEY':
              table = db.surveys;
              break;
          }

          db.transaction('rw', table, () => {
            table.put(submission);
          });

          if (reset) {
            instance.clearCurrentForm();
          }
        },
        _loadCollectionFromDatabase(collection, callback) {
          let instance = this;
          collection.toArray()
            .then(entries => callback(entries));
        },
        loadFormsFromDatabase() {
          let instance = this;
          db.forms.get(1)
            .then(forms => {
              instance.forms = forms;
            });
        },
        loadChecklistsFromDatabase() {
          let instance = this;
          instance._loadCollectionFromDatabase(db.checklists, entries => {
            instance.checklists = entries.reduce((registry, submission) => {
              registry[submission.form] = submission;
              return registry;
            }, {});
          });
        },
        loadIncidentsFromDatabase() {
          let instance = this;
          instance._loadCollectionFromDatabase(db.incidents, entries => {
            instance.incidents = entries.reduce((registry, incident) => {
              let storage = registry[incident.form] || [];
              storage.push(incident);
              registry[incident.form] = storage;
              return registry;
            }, {});
          });
        },
        loadSurveysFromDatabase() {
          let instance = this;
          instance._loadCollectionFromDatabase(db.surveys, entries => {
            instance.surveys = entries.reduce((registry, survey) => {
              let storage = registry[survey.form] || [];
              storage.push(survey);
              registry[survey.form] = storage;
              return registry;
            }, {});
          });
        },
        async refresh() {
          let instance = this;
          let result = await client.refresh(instance.participant.tokens.refreshToken);
          if (result.status === 200) {
            let data = await result.result;
            let participant = Object.assign({}, instance.participant, {tokens: {accessToken: data.access_token}});
            instance.participant = participant;
            console.log(participant);
            instance.saveParticipantToDatabase(participant);
          }
        },
        async postSubmission(submission, single = true) {
          let formData = new FormData();
          for (let key of Object.keys(submission.images)) {
            formData.append(key, submission.images[key], submission.images[key].name);
          }
          let subCopy = Object.assign({}, {form: submission.form, data: submission.data, serial: submission.serial});
          formData.append('submission', JSON.stringify(subCopy));

          for (let tries = 0; tries < 2; tries++) {
            // definitely a better way of doing this, but
            // the general idea is that if we get a 401
            // once, we will request a new access token
            // automatically and attempt to send again.
            // if it happens again,
            // we request that the user logs in again
            // if the API returns anything else,
            // we break out of this loop.
            try {
              let result = await client.submit(this.participant.tokens.accessToken, formData);
              // if we get a 401, we can send a refresh
              if (result.status === 401) {
                if (tries === 1) {
                  Notiflix.Report.Warning(
                    '{{ _("Session expired") }}',
                    '{{ _("Please login again to send your data") }}',
                    '{{ _("OK") }}',
                  );
                  this.participant = null;
                  return;
                } else {
                  this.refresh();
                  continue;
                }
              } else if (result.status !== 200) {
                let data = await result.result;
                if (single)
                  Notiflix.Report.Failure(
                    '{{ _("Error") }}',
                    data.message,
                    '{{ _("OK") }}',
                  );
                else {
                  submission.status = 'error';
                  submission.errorMessage = data.message;
                }
              } else {
                if (single)
                  Notiflix.Report.Success(
                    '{{ _("Success") }}',
                    '{{ _("Data successfully submitted") }}',
                    '{{ _("OK") }}',
                  );
                submission.status = 'ok';
              }
            } catch (error) {
              submission.status = 'error';
              submission.errorMessage = '{{ _("Offline") }}';
  
              if (single) {
                Notiflix.Report.Failure(
                  '{{ _("Error") }}',
                  '{{ _("Error posting data. Might you be offline?") }}',
                  '{{ _("OK") }}',
                );
              }
            }
            break;
          }

          // set posted, and reset editor if editing
          let reset = single ? true : false;
          submission.posted = new Date();
          this.saveSubmissionToDatabase(submission, reset);
        },
        showSubmissionList(form) {
          if (form.form_type !== 'CHECKLIST') {
            this.currentForm = form;
            if (form.form_type === 'INCIDENT')
              this.loadIncidentsFromDatabase();
            else
              this.loadSurveysFromDatabase();
          }
        }
      },
      mounted() {
        this.loadParticipantFromDatabase();
        this.loadFormsFromDatabase();
        this.loadChecklistsFromDatabase();
        this.loadIncidentsFromDatabase();
        this.loadSurveysFromDatabase();

        let onlineHook = () => {
          this.navigatorOnline = navigator.onLine;
        };
        window.addEventListener('offline', onlineHook);
        window.addEventListener('online', onlineHook);
      }
    });
  </script>
</body>
</html>