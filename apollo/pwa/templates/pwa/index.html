<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('pwa.static', filename='vendor/animate.css/animate.min.css') }}">
  {% if g.locale.text_direction == 'rtl' %}
  <link rel="stylesheet" href="{{ url_for('pwa.static', filename='vendor/bootstrap/css/bootstrap.rtl.min.css') }}">
  {% else %}
  <link rel="stylesheet" href="{{ url_for('pwa.static', filename='vendor/bootstrap/css/bootstrap.min.css') }}">
  {% endif %}
  <link rel="stylesheet" href="{{ url_for('pwa.static', filename='vendor/notiflix/notiflix-2.7.0.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('pwa.static', filename='css/main.css') }}">
  <title>{{ page_title }}</title>
</head>
<body class="h-100">
  <div id="app">
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top mb-6">
      <div class="container-fluid">
        <a class="navbar-brand">{{ page_title }}</a>
        <connectivity-indicator></connectivity-indicator>
      </div>
    </nav>
    <main class="container h-100">
      <div class="row h-75 align-items-center">
        <div class="col-md-6 offset-md-3">
          <login-form v-if="participant === null" @authenticated="authenticationSuccess"></login-form>
          <landing v-else :participant="participant" @logged-out="loggedOut"></landing>
        </div>
      </div>
    </main>
  </div>
  <template id="connectivity-indicator">
    <div class="d-flex text-light">
      <svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg" v-if="isOnline"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.636 5.636a1 1 0 00-1.414-1.414c-4.296 4.296-4.296 11.26 0 15.556a1 1 0 001.414-1.414 9 9 0 010-12.728zm14.142-1.414a1 1 0 10-1.414 1.414 9 9 0 010 12.728 1 1 0 101.414 1.414c4.296-4.296 4.296-11.26 0-15.556zM8.464 8.464A1 1 0 007.05 7.05a7 7 0 000 9.9 1 1 0 101.414-1.414 5 5 0 010-7.072zM16.95 7.05a1 1 0 10-1.414 1.414 5 5 0 010 7.072 1 1 0 001.414 1.414 7 7 0 000-9.9zM9 12a3 3 0 116 0 3 3 0 01-6 0z" fill="currentColor"/></svg>
      <svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg" v-else><path fill-rule="evenodd" clip-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414L15.535 16.95l2.829 2.828 1.929 1.93a1 1 0 001.414-1.415l-1.253-1.254c3.607-4.321 3.382-10.76-.676-14.817a1 1 0 10-1.414 1.414 9.001 9.001 0 01.668 11.982l-1.425-1.425a7.002 7.002 0 00-.657-9.143 1 1 0 10-1.414 1.414 5.002 5.002 0 01.636 6.294l-1.465-1.465a3 3 0 00-4-4l-7-7zM3.75 8.4a1 1 0 00-1.834-.8C.161 11.624.928 16.485 4.222 19.778a1 1 0 001.414-1.414A9.004 9.004 0 013.749 8.4zm3.32 2.766a1 1 0 00-1.972-.332A6.992 6.992 0 007.05 16.95a1 1 0 101.414-1.414 4.993 4.993 0 01-1.394-4.37z" fill="currentColor"/></svg>
    </div>
  </template>
  <template id="login-form">
    <div class="form-signin">
      <form>
        <div class="card">
          <h5 class="card-header">{{ _('Login') }}</h5>
          <div class="card-body">
            <div class="mb-3">
              <label for="participant_id" class="visually-hidden">{{ _('Participant ID') }}</label>
              <input type="text" class="form-control bg-light" id="participant_id" placeholder="{{ _('Participant ID') }}" v-model="participant_id">
            </div>
            <div class="mb-3">
              <label for="password" class="visually-hidden">{{ _('Password') }}</label>
              <input type="password" class="form-control bg-light" id="password" placeholder="{{ _('Password') }}" v-model="password">
            </div>
            <div class="mb-3">
              <div class="d-grid gap-2">
                <button class="btn btn-primary" @click="authenticate($event)">{{ _('Login') }}</button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </template>
  <template id="landing">
    <div>
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">[[ greeting() ]], [[ participant.full_name ]]</h5>
          <p>{{ _('If this is not you, please') }} <a @click="logout" class="btn btn-outline-dark">{{ _('click here') }}</a></p>
        </div>
      </div>
    </div>
  </template>
  <script src="{{ url_for('pwa.static', filename='vendor/bootstrap/js/bootstrap.min.js') }}"></script>
  <script src="{{ url_for('pwa.static', filename='vendor/dexie/dexie.min.js') }}"></script>
  <script src="{{ url_for('pwa.static', filename='vendor/image-blob-reduce/image-blob-reduce.min.js') }}"></script>
  <script src="{{ url_for('pwa.static', filename='vendor/notiflix/notiflix-2.7.0.min.js') }}"></script>
  <script src="{{ url_for('pwa.static', filename='vendor/vue/vue.js') }}"></script>
  <script src="{{ url_for('pwa.static', filename='js/client.js') }}"></script>
  <script>
    // API setup
    const endpoints = {
      list: "{{ url_for('forms.api_form_list') }}",
      login: "{{ url_for('participants.login') }}",
      logout: "{{ url_for('participants.logout') }}",
      logout2: "{{ url_for('participants.logout2') }}",
      refresh: "{{ url_for('participants.refresh') }}",
      submit: "{{ url_for('submissions.submission') }}",
    };
    const client = new APIClient(endpoints);

    // database setup
    const db = new Dexie('apollo');
    db.version(1).stores({
      forms: '',
      participant: '',
      submissions: '++id, form'
    });
    db.open().catch(() => {
      Notiflix.Report.Failure(
        '{{ _("Error") }}',
        '{{ _("There was an error with the data storage") }}',
        '{{ _("OK") }}',
      );
    });

    // image reducer
    const imageResizer = new ImageBlobReduce({
      pica: ImageBlobReduce.pica({features: ['js', 'wasm', 'ww']})
    });
    const convertBlobToBase64 = blob => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = reject;
      reader.onload = () => {
        resolve(reader.result);
      }
      reader.readAsDataURL(blob);
    });

    // app setup
    Vue.options.delimiters = ['[[', ']]'];

    // component for online status
    Vue.component('connectivity-indicator', {
      data() {
        return {
          isOnline: navigator.onLine
        };
      },

      methods: {
        toggleOnlineStatus() {
          this.isOnline = navigator.onLine;
        }
      },

      mounted() {
        window.addEventListener('offline', this.toggleOnlineStatus);
        window.addEventListener('online', this.toggleOnlineStatus);
      },

      template: '#connectivity-indicator'
    });

    // login component
    Vue.component('login-form', {
      data() {
        return {
          participant_id: null,
          password: null
        };
      },
      methods: {
        authenticate(event) {
          event.preventDefault();
          let instance = this;
          Notiflix.Loading.Standard('{{ _("Please wait") }}');
          client.authenticate(this.participant_id, this.password)
            .then(result => {
              Notiflix.Loading.Remove();
              if (result.status === 200) {
                result.result.then(data => {
                  let participant = data.data.participant;
                  participant.tokens = {
                    accessToken: data.data.access_token,
                    refreshToken: data.data.refresh_token
                  };
                  instance.$emit('authenticated', participant);
                });
              } else {
                Notiflix.Report.Failure(
                  '{{ _("Error") }}',
                  '{{ _("Please check your credentials and try again") }}',
                  '{{ _("OK") }}',
                );
              }
            })
            .catch(() => {
              Notiflix.Loading.Remove();
            });
        }
      },
      props: [],
      template: '#login-form'
    });

    // landing component
    Vue.component('landing', {
      computed: {
      },
      data() {
        return {};
      },
      methods: {
        greeting() {
          let dt = new Date();
          if (dt.getHours() < 12)
            return '{{ _("Good morning") }}';
          else if (12 >= dt.getHours() && dt.getHours() < 17)
            return '{{ _("Good afternoon") }}';
          else
            return '{{ _("Good evening") }}';
        },
        logout() {
          this.$emit('logged-out');
        }
      },
      props: ['participant'],
      template: '#landing'
    });

    // main app
    let vm;
    vm = new Vue({
      data: {
        participant: null
      },
      el: '#app',
      methods: {
        authenticationSuccess(participant) {
          this.participant = participant;
          this.saveParticipantToDatabase(participant);
        },
        clearDatabase() {
          db.transaction('rw', [db.forms, db.participant, db.submissions], () => {
            db.forms.clear();
            db.participant.clear();
            db.submissions.clear();
          });
        },
        loadParticipantFromDatabase() {
          let instance = this;
          db.participant.get(1)
            .then(participant => {
              if (participant)
                instance.participant = participant;
            })
            .catch(() =>
              Notiflix.Report.Failure(
                '{{ _("Error") }}',
                '{{ _("Could not load data from database") }}',
                '{{ _("OK") }}',
              )
            );
        },
        saveParticipantToDatabase(participant) {
          db.transaction('rw', db.participant, () => {
            db.participant.put(participant, 1);
          }).catch(() => Notiflix.Report.Failure(
            '{{ _("Error") }}',
            '{{ _("Could not save data to the database") }}',
            '{{ _("OK") }}',
          ));
        },
        loggedOut() {
          client.logout(this.participant.tokens.accessToken);
          client.logout2(this.participant.tokens.refreshToken);
          this.participant = null;
          this.clearDatabase();
        }
      },
      mounted() {
        this.loadParticipantFromDatabase();
      }
    });
  </script>
</body>
</html>